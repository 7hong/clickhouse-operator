version: v1beta9
images:
  metrics-exporter:
    image: altinity/metrics-exporter
    tags: ['devspace']
    preferSyncOverRebuild: false
    build:
      custom:
        command: deploy/devspace/docker-build.sh
        args:
          - "--debug=${DEVSPACE_DEBUG}"
  clickhouse-operator:
    image: altinity/clickhouse-operator
    tags: ['devspace']
    preferSyncOverRebuild: false
    build:
      custom:
        command: deploy/devspace/docker-build.sh
        args:
          - "--debug=${DEVSPACE_DEBUG}"

deployments:
- name: clickhouse-operator
  kubectl:
    manifests:
      - deploy/devspace/clickhouse-operator-install.yaml

vars:
  - name: OPERATOR_NAMESPACE
    question: Which kubenetes namespace do you want to use for clickhouse-operator deployment?
    default: "kube-system"
  - name: DEVSPACE_DEBUG
    question: Should build docker images with debugger (please choose delve or none)?
    default: "delve"

hooks:
  # transform yaml installation manifest to change images and namespace
  - command: bash
    args:
      - -xec
      - "OPERATOR_NAMESPACE=${OPERATOR_NAMESPACE} deploy/devspace/yq_transform_clickhouse-operator-install.sh"
    when:
      before:
        deployments: all

dev:
  ports:
  - imageName: metrics-exporter
    forward:
      - port: 8888
        remotePort: 8888
      - port: 40001
        remotePort: 40001
  - imageName: clickhouse-operator
    forward:
      - port: 40002
        remotePort: 40002

  autoReload:
    paths:
      - config/*
      - cmd/*
      - dev/*
      - deploy/*
      - dockerfile/*
      - pkg/*
      - go.mod
    images:
      - metrics-exporter
      - clickhouse-operator
    deployments:
      - clickhouse-operator

profiles:
- name: production
  patches:
  - op: remove
    path: images.app.injectRestartHelper
